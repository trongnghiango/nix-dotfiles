#!/usr/bin/env bash

# --- 1. CONFIG ---
WM="dwm"
STATUSBAR="dwmblocks"

# HÃ m láº¥y PID cá»§a DWM an toÃ n trÃªn NixOS
get_wm_pid() {
    # pgrep -x tÃ¬m chÃ­nh xÃ¡c tÃªn process, an toÃ n hÆ¡n pstree
    pgrep -x "$WM" | head -n 1
}

# HÃ m khÃ³a mÃ¡y & xá»­ lÃ½ Ã¢m thanh
lock() {
    # Táº¡m dá»«ng nháº¡c náº¿u cÃ³ mpc/mpv
    command -v mpc >/dev/null && mpc pause
    command -v pauseallmpv >/dev/null && pauseallmpv

    # Mute Ã¢m thanh (DÃ¹ng 1 Ä‘á»ƒ force mute, trÃ¡nh toggle nháº§m)
    if command -v wpctl >/dev/null; then
        wpctl set-mute @DEFAULT_AUDIO_SINK@ 1
        # Gá»­i tÃ­n hiá»‡u update icon volume (Signal 11 cá»§a báº¡n)
        pkill -RTMIN+11 "$STATUSBAR"
    fi

    # KhÃ³a mÃ n hÃ¬nh (Cháº¡y blocking)
    slock

    # Má»Ÿ láº¡i Ã¢m thanh sau khi unlock
    if command -v wpctl >/dev/null; then
        wpctl set-mute @DEFAULT_AUDIO_SINK@ 0
        pkill -RTMIN+11 "$STATUSBAR"
    fi
}

# --- 2. MENU DEFINITION ---
# DÃ¹ng chuá»—i Ä‘Æ¡n giáº£n Ä‘á»ƒ trÃ¡nh lá»—i cÃº phÃ¡p
# Format: "Icon TÃªn|Lá»‡nh"
options="ğŸ”’ Lock
ğŸšª Leave $WM
â™»ï¸ Renew $WM
ğŸ» Hibernate
ğŸ’¤ Sleep
ğŸ”ƒ Reboot
ğŸ›‘ Shutdown
ğŸ“º Display Off"

# --- 3. HIá»‚N THá»Š DMENU ---
# -i: Case insensitive
# -p: Prompt
selected="$(echo -e "$options" | dmenu -i -p 'System:')"

# --- 4. Xá»¬ LÃ Lá»†NH ---
case "$selected" in
    *'Lock')
        lock ;;
    *'Leave'*)
        # Gá»­i tÃ­n hiá»‡u káº¿t thÃºc cho DWM Ä‘á»ƒ thoÃ¡t ra TTY/Login manager
        kill -TERM "$(get_wm_pid)" ;;
    *'Renew'*)
        # Restart DWM táº¡i chá»— (Cáº§n patch restartsig)
        kill -HUP "$(get_wm_pid)" ;;
    *'Hibernate')
        # Cháº¡y lock trÆ°á»›c rá»“i má»›i ngá»§ Ä‘Ã´ng
        slock & systemctl hibernate ;;
    *'Sleep')
        # Cháº¡y lock trÆ°á»›c rá»“i má»›i sleep
        slock & systemctl suspend ;;
    *'Reboot')
        systemctl reboot ;;
    *'Shutdown')
        systemctl poweroff ;;
    *'Display'*)
        xset dpms force off ;;
esac
