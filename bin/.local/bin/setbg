#!/bin/sh
# setbg â€” Smart wallpaper setter with WebP support
# Author: upgraded version
# POSIX compliant

set -eu

### CONFIG ###########################################################

XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"

BGLINK="$XDG_DATA_HOME/bg"
CACHE_DIR="$XDG_DATA_HOME/setbg"
CACHE_IMG="$CACHE_DIR/wallpaper.png"

DUNSTCONF="$XDG_CONFIG_HOME/dunst/dunstrc"
ZATHURACONF="$XDG_CONFIG_HOME/zathura/zathurarc"

mkdir -p "$CACHE_DIR"

### FLAGS ############################################################

SILENT=0
while getopts "s" o; do
    case "$o" in
        s) SILENT=1 ;;
    esac
done
shift $((OPTIND - 1))

### UTILS ############################################################

notify() {
    [ "$SILENT" -eq 1 ] && return
    notify-send -i "$BGLINK" "ðŸ–¼ setbg" "$1"
}

die() {
    notify "$1"
    exit 1
}

mime() {
    file --mime-type -b "$1"
}

### IMAGE RESOLUTION #################################################

resolve_image() {
    img="$1"
    m="$(mime "$img")"

    case "$m" in
        image/webp)
            if command -v magick >/dev/null 2>&1; then
                magick "$img" "$CACHE_IMG"
                echo "$CACHE_IMG"
            elif command -v dwebp >/dev/null 2>&1; then
                dwebp "$img" -o "$CACHE_IMG"
                echo "$CACHE_IMG"
            else
                die "WebP detected but no converter found (install imagemagick or libwebp)"
            fi
            ;;
        image/*)
            echo "$img"
            ;;
        *)
            die "Unsupported file type: $m"
            ;;
    esac
}

### INPUT HANDLING ###################################################

[ $# -eq 0 ] && die "No input provided"

TARGET="$(readlink -f "$1")"

if [ -d "$TARGET" ]; then
    TARGET="$(find "$TARGET" -type f \
        \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.gif' -o -iname '*.webp' \) \
        | shuf -n 1)"
fi

[ -f "$TARGET" ] || die "Not a valid image or directory"

ln -sf "$TARGET" "$BGLINK"

IMG="$(resolve_image "$TARGET")"

### PYWAL ############################################################

if command -v wal >/dev/null 2>&1; then
    wal -n -i "$IMG" -o "$XDG_CONFIG_HOME/wal/postrun" >/dev/null 2>&1 || true
else
    [ -f "$DUNSTCONF.bak" ] && mv "$DUNSTCONF.bak" "$DUNSTCONF"
    [ -f "$ZATHURACONF.bak" ] && mv "$ZATHURACONF.bak" "$ZATHURACONF"
fi

### SET WALLPAPER ####################################################

xwallpaper --zoom "$IMG"

### REFRESH WM #######################################################

pidof dwm >/dev/null 2>&1 && xdotool key super+F5

notify "Wallpaper updated successfully"

