#!/bin/bash

# --- CẤU HÌNH ---
APP_BASE="$HOME/Applications"
REPO_DIR="$APP_BASE/repo"
BIN_DIR="$APP_BASE/bin"
ICON_DIR="$HOME/.local/share/icons"
# ----------------

info() { echo -e "\033[1;34m[INFO]\033[0m $1"; }
success() { echo -e "\033[1;32m[OK]\033[0m $1"; }
error() { echo -e "\033[1;31m[ERROR]\033[0m $1"; }
warn() { echo -e "\033[1;33m[WARN]\033[0m $1"; }

usage() {
  echo "Usage: aim <command> [options]"
  echo "  install -n <Name> -s <Source> [-i <IconPath>]"
  echo "  clean -n <Name>"
  exit 1
}

cmd_install() {
  local app_name=""
  local source_input=""
  local icon_input=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
    -n | --name)
      app_name="$2"
      shift 2
      ;;
    -s | --source)
      source_input="$2"
      shift 2
      ;;
    -i | --icon)
      icon_input="$2"
      shift 2
      ;;
    *)
      error "Tham số lạ: $1"
      usage
      ;;
    esac
  done

  if [[ -z "$app_name" || -z "$source_input" ]]; then
    error "Thiếu tên (-n) hoặc nguồn (-s)."
    usage
  fi

  local target_dir="$REPO_DIR/$app_name"
  mkdir -p "$target_dir"
  mkdir -p "$BIN_DIR"
  mkdir -p "$ICON_DIR" # Đảm bảo thư mục icon tồn tại

  info "Đang cài đặt: $app_name"

  # --- 1. DOWNLOAD / COPY APPIMAGE ---
  local filename=""
  if [[ "$source_input" =~ ^https?:// ]]; then
    local clean_url="${source_input%%\?*}"
    filename=$(basename "$clean_url")
    local target_file="$target_dir/$filename"
    info "Đang tải từ URL..."
    if command -v curl &>/dev/null; then
      curl -L "$source_input" -o "$target_file" --progress-bar
    elif command -v wget &>/dev/null; then
      wget -O "$target_file" "$source_input" -q --show-progress
    else
      error "Cần curl hoặc wget."
      exit 1
    fi
  else
    if [[ ! -f "$source_input" ]]; then
      error "File nguồn không tồn tại."
      exit 1
    fi
    filename=$(basename "$source_input")
    local target_file="$target_dir/$filename"
    if [[ "$source_input" != "$target_file" ]]; then cp "$source_input" "$target_file"; fi
  fi

  local full_path="$target_dir/$filename"
  chmod +x "$full_path"

  # --- 2. XỬ LÝ ICON (AUTO EXTRACT vs CUSTOM) ---
  local icon_target_name="${app_name,,}" # Tên icon trong hệ thống (viết thường)

  if [[ -n "$icon_input" ]]; then
    # CASE A: Người dùng cung cấp icon riêng (-i)
    if [[ -f "$icon_input" ]]; then
      local ext="${icon_input##*.}"
      cp "$icon_input" "$ICON_DIR/${icon_target_name}.${ext}"
      success "Đã cập nhật Custom Icon."
    else
      warn "File icon custom không tồn tại. Sẽ thử tự động lấy."
    fi
  else
    # CASE B: Tự động trích xuất từ AppImage
    info "Đang trích xuất icon từ AppImage..."
    cd "$target_dir"

    # AppImage có tính năng trích xuất file .DirIcon
    # Lệnh này sẽ tạo thư mục squashfs-root chứa file .DirIcon
    "$full_path" --appimage-extract .DirIcon >/dev/null 2>&1

    if [[ -f "squashfs-root/.DirIcon" ]]; then
      # Xác định loại file (thường là png hoặc svg)
      local icon_source="squashfs-root/.DirIcon"
      local file_type=$(file --mime-type -b "$icon_source")
      local ext="png" # Mặc định

      if [[ "$file_type" == *"svg"* ]]; then ext="svg"; fi

      # Di chuyển và đổi tên icon vào hệ thống
      mv "$icon_source" "$ICON_DIR/${icon_target_name}.${ext}"
      success "Đã trích xuất và cài đặt Icon thành công!"
    else
      warn "Không tìm thấy icon trong AppImage. App sẽ dùng icon mặc định hệ thống."
    fi

    # Dọn dẹp thư mục tạm do việc trích xuất tạo ra
    rm -rf squashfs-root
  fi

  # --- 3. TẠO SYMLINK ---
  cd "$target_dir"
  ln -sf "$filename" "${app_name}-current.AppImage"

  # --- 4. TẠO WRAPPER ---
  local wrapper_path="$BIN_DIR/${app_name,,}"
  if [[ ! -f "$wrapper_path" ]]; then
    echo "#!/bin/bash" >"$wrapper_path"
    echo "exec \"$target_dir/${app_name}-current.AppImage\" \"\$@\"" >>"$wrapper_path"
    chmod +x "$wrapper_path"
  fi

  # --- 5. TẠO .DESKTOP ---
  local desktop_file="$HOME/.local/share/applications/${app_name,,}.desktop"
  # Luôn ghi đè file .desktop để đảm bảo path icon đúng
  cat <<EOT >"$desktop_file"
[Desktop Entry]
Name=$app_name
Exec=$wrapper_path %u
Icon=$icon_target_name
Type=Application
Terminal=false
Categories=Utility;
EOT
  success "Đã cập nhật file .desktop"
  success "HOÀN TẤT: ${app_name,,}"
}

cmd_clean() {
  local app_name=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
    -n | --name)
      app_name="$2"
      shift 2
      ;;
    *)
      error "Sai tham số clean"
      exit 1
      ;;
    esac
  done
  if [[ -z "$app_name" ]]; then
    error "Thiếu tên app (-n)"
    exit 1
  fi
  local target_dir="$REPO_DIR/$app_name"
  if [[ ! -d "$target_dir" ]]; then
    error "App chưa cài."
    exit 1
  fi

  info "Dọn dẹp $app_name..."
  cd "$target_dir"
  ls -t *.AppImage 2>/dev/null | grep -v "current" | tail -n +3 | xargs -I {} rm -v -- {}
  success "Xong."
}

COMMAND="$1"
shift
case "$COMMAND" in
install) cmd_install "$@" ;;
clean) cmd_clean "$@" ;;
list) ls -1 "$REPO_DIR" ;;
*) usage ;;
esac
