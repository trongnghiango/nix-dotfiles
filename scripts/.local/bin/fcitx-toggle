#!/bin/sh

# Dùng pidof để kiểm tra chính xác tiến trình có đang chạy không.
# > /dev/null nghĩa là không in ra màn hình, chỉ lấy mã thoát (exit code).
if pidof fcitx5 >/dev/null; then
  # ==================================================
  # TRƯỜNG HỢP 1: ĐANG CHẠY (Yên tâm, không start lại)
  # ==================================================

  # Chỉ gửi lệnh chuyển đổi
  fcitx5-remote -t

  # (Tùy chọn) Gửi thông báo trạng thái hiện tại
  # STATUS=$(fcitx5-remote)
  # [ "$STATUS" = "2" ] && notify-send -t 500 "Fcitx5" "Tiếng Việt" || notify-send -t 500 "Fcitx5" "English"

else
  # ==================================================
  # TRƯỜNG HỢP 2: CHƯA CHẠY (Lúc này mới được bật)
  # ==================================================

  # 1. Khởi động daemon
  fcitx5 -d &

  # 2. Vòng lặp chờ thông minh
  # Chờ tối đa 20 lần (2 giây), mỗi lần 0.1s
  MAX_TRY=20
  while ! fcitx5-remote >/dev/null 2>&1; do
    sleep 0.1
    MAX_TRY=$((MAX_TRY - 1))
    if [ $MAX_TRY -le 0 ]; then
      notify-send "Fcitx5" "Lỗi: Không khởi động được!"
      exit 1
    fi
  done

  # 3. Sau khi đã lên: Bật luôn tiếng Việt (Active)
  # -o là open (bật), -c là close (tắt/tiếng Anh)
  fcitx5-remote -o

  notify-send -t 1000 "Fcitx5" "Đã khởi động (Tiếng Việt)"
fi
pkill -RTMIN+10 dwmblocks
