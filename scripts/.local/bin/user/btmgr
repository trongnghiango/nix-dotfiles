#!/bin/bash
# ~/.local/bin/bt-connect-fixed

# M√†u s·∫Øc
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# H√†m ki·ªÉm tra Bluetooth status
check_bluetooth() {
  if ! systemctl is-active --quiet bluetooth; then
    echo -e "${RED}Bluetooth service is not running${NC}"
    echo "Starting bluetooth service..."
    sudo systemctl start bluetooth
    sleep 2
  fi

  local powered=$(bluetoothctl show | grep -i "powered:" | awk '{print $2}')
  if [ "$powered" != "yes" ]; then
    echo -e "${RED}Bluetooth is powered off${NC}"
    echo -e "${BLUE}Turning Bluetooth on...${NC}"
    bluetoothctl power on
    sleep 1
  fi
}

# H√†m qu√©t thi·∫øt b·ªã v·ªõi timeout
scan_devices() {
  echo -e "${YELLOW}Scanning for Bluetooth devices...${NC}"
  echo "Make sure your device is in pairing mode!"

  # ƒê·∫£m b·∫£o kh√¥ng c√≥ scan n√†o ƒëang ch·∫°y
  bluetoothctl scan off >/dev/null 2>&1

  # B·∫≠t discoverable
  bluetoothctl discoverable on

  # B·∫Øt ƒë·∫ßu scan v·ªõi progress bar
  bluetoothctl scan on >/dev/null 2>&1 &
  local scan_pid=$!

  echo -ne "[                    ] 0%"
  for i in {1..20}; do
    sleep 1
    progress=$((i * 5))
    bars=$((i / 2))
    spaces=$((20 - bars))
    echo -ne "\r["
    for ((j = 0; j < bars; j++)); do echo -ne "‚ñà"; done
    for ((j = 0; j < spaces; j++)); do echo -ne " "; done
    echo -ne "] ${progress}%"
  done

  # D·ª´ng scan
  kill $scan_pid 2>/dev/null
  bluetoothctl scan off >/dev/null 2>&1
  echo -e "\n${GREEN}Scan completed!${NC}"
}

# H√†m ch·ªçn thi·∫øt b·ªã v·ªõi ki·ªÉm tra
select_device() {
  # L·∫•y danh s√°ch thi·∫øt b·ªã
  local devices_raw=$(bluetoothctl devices 2>/dev/null)

  if [ -z "$devices_raw" ]; then
    echo -e "${RED}No Bluetooth devices found.${NC}"
    echo "Try:"
    echo "1. Ensure device is in pairing mode"
    echo "2. Move device closer"
    echo "3. Rescan with option 1"
    return 1
  fi

  # Format output cho fzf
  echo "$devices_raw" | while read -r line; do
    mac=$(echo "$line" | awk '{print $2}')
    name=$(echo "$line" | cut -d' ' -f3-)
    status=""

    # Ki·ªÉm tra n·∫øu ƒë√£ paired
    if bluetoothctl info "$mac" 2>/dev/null | grep -q "Paired: yes"; then
      status="[Paired]"
    fi

    # Ki·ªÉm tra n·∫øu ƒëang connected
    if bluetoothctl info "$mac" 2>/dev/null | grep -q "Connected: yes"; then
      status="[Connected]"
    fi

    printf "%-18s %-40s %s\n" "$mac" "$name" "$status"
  done | fzf \
    --height=50% \
    --layout=reverse \
    --prompt="Select device > " \
    --header="Enter: Select | Ctrl+R: Rescan | ESC: Cancel" \
    --bind="ctrl-r:reload(bluetoothctl devices)" \
    --bind="ctrl-l:execute(bluetoothctl info {1})" |
    awk '{print $1}'
}

# H√†m k·∫øt n·ªëi an to√†n
connect_to_device() {
  local mac="$1"

  if [ -z "$mac" ]; then
    echo -e "${RED}No device selected${NC}"
    return 1
  fi

  echo -e "${YELLOW}Attempting to connect to $mac${NC}"

  # Ki·ªÉm tra device c√≥ t·ªìn t·∫°i kh√¥ng
  if ! bluetoothctl info "$mac" &>/dev/null; then
    echo -e "${RED}Device $mac not found${NC}"
    return 1
  fi

  # Th·ª≠ pair n·∫øu ch∆∞a paired
  if ! bluetoothctl info "$mac" | grep -q "Paired: yes"; then
    echo -e "${BLUE}Pairing device...${NC}"
    if ! bluetoothctl pair "$mac"; then
      echo -e "${RED}Pairing failed${NC}"

      # Th·ª≠ remove v√† pair l·∫°i
      echo "Trying to remove and repair..."
      bluetoothctl remove "$mac" 2>/dev/null
      sleep 1

      if ! bluetoothctl pair "$mac"; then
        echo -e "${RED}Still cannot pair. Make sure device is in pairing mode.${NC}"
        return 1
      fi
    fi
    echo -e "${GREEN}Paired successfully${NC}"
  fi

  # Trust device
  echo "Setting device as trusted..."
  bluetoothctl trust "$mac"

  # Connect
  echo "Connecting..."
  if bluetoothctl connect "$mac"; then
    echo -e "${GREEN}‚úì Connected successfully!${NC}"

    # Hi·ªÉn th·ªã th√¥ng tin
    echo -e "\n${YELLOW}Device Information:${NC}"
    bluetoothctl info "$mac" | grep -E "(Name:|Alias:|Paired:|Connected:|UUID:)" | head -10

    # G·ª£i √Ω audio setup n·∫øu l√† audio device
    if bluetoothctl info "$mac" | grep -qi "audio\|headphone\|headset"; then
      echo -e "\n${BLUE}Audio device detected.${NC}"
      echo "To set as audio output, run:"
      echo "  pactl set-card-profile <card> a2dp_sink"
      echo "Find card with: pactl list cards | grep -A5 bluez"
    fi
  else
    echo -e "${RED}‚úó Connection failed${NC}"
    return 1
  fi
}

# Menu ch√≠nh ƒë∆°n gi·∫£n h∆°n
show_menu() {
  clear
  echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
  echo -e "${BLUE}‚ïë     Bluetooth Manager (Fixed)        ‚ïë${NC}"
  echo -e "${BLUE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
  echo " 1. üîç Scan for devices"
  echo " 2. üìã Show paired devices"
  echo " 3. üîó Connect to device"
  echo " 4. ‚ùå Disconnect device"
  echo " 5. ‚ö° Bluetooth power toggle"
  echo " 6. üõ†Ô∏è  Bluetooth diagnostics"
  echo " 7. üö™ Exit"
  echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
  echo ""
}

# Diagnostics
run_diagnostics() {
  echo -e "${YELLOW}=== Bluetooth Diagnostics ===${NC}"
  echo ""

  # 1. Service status
  echo "1. Service Status:"
  systemctl status bluetooth --no-pager -l | head -10

  echo ""

  # 2. Adapter info
  echo "2. Adapter Information:"
  bluetoothctl show

  echo ""

  # 3. Devices
  echo "3. Found Devices:"
  bluetoothctl devices

  echo ""

  # 4. rfkill status
  echo "4. RFKill Status:"
  rfkill list bluetooth

  echo ""

  # 5. Kernel modules
  echo "5. Bluetooth Kernel Modules:"
  lsmod | grep -i blue

  echo ""
  echo -e "${GREEN}Diagnostics complete.${NC}"
}

# Main
main() {
  # Ki·ªÉm tra dependencies
  if ! command -v bluetoothctl &>/dev/null; then
    echo -e "${RED}bluetoothctl not found. Install:${NC}"
    echo "sudo pacman -S bluez bluez-utils"
    exit 1
  fi

  if ! command -v fzf &>/dev/null; then
    echo -e "${RED}fzf not found. Install:${NC}"
    echo "sudo pacman -S fzf"
    exit 1
  fi

  while true; do
    show_menu
    read -p "Select option [1-7]: " choice

    case $choice in
    1)
      echo ""
      check_bluetooth
      scan_devices
      mac=$(select_device)
      if [ -n "$mac" ]; then
        connect_to_device "$mac"
      else
        echo -e "${YELLOW}No device selected${NC}"
      fi
      ;;
    2)
      echo ""
      echo -e "${YELLOW}Paired Devices:${NC}"
      bluetoothctl devices Paired || echo "No paired devices"
      ;;
    3)
      echo ""
      mac=$(select_device)
      if [ -n "$mac" ]; then
        connect_to_device "$mac"
      fi
      ;;
    4)
      echo ""
      echo -e "${YELLOW}Connected Devices:${NC}"
      connected=$(bluetoothctl devices Connected)
      if [ -z "$connected" ]; then
        echo "No connected devices"
      else
        echo "$connected"
        echo ""
        mac=$(echo "$connected" | fzf --height=30% --layout=reverse --prompt="Select to disconnect: " | awk '{print $2}')
        if [ -n "$mac" ]; then
          bluetoothctl disconnect "$mac"
          echo -e "${GREEN}Disconnected $mac${NC}"
        fi
      fi
      ;;
    5)
      echo ""
      if bluetoothctl show | grep -q "Powered: yes"; then
        bluetoothctl power off
        echo -e "${YELLOW}Bluetooth turned OFF${NC}"
      else
        bluetoothctl power on
        echo -e "${GREEN}Bluetooth turned ON${NC}"
      fi
      ;;
    6)
      run_diagnostics
      ;;
    7)
      echo -e "${GREEN}Exiting...${NC}"
      exit 0
      ;;
    *)
      echo -e "${RED}Invalid option${NC}"
      ;;
    esac

    echo ""
    read -p "Press Enter to continue..."
  done
}

# Run
main
