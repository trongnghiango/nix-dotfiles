#!/usr/bin/env bash

# ==============================================================================
# GIT MANAGER (gm) - v3.0 Final
# Author: NghiaNgo (Generated via AI Assistant)
# Description: Multi-account Git management tool with specific directory structure.
# ==============================================================================

# CONFIGURATION
REPOS_ROOT="$HOME/Repos"
VERSION="3.0.0"

# COLORS & STYLES
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ==============================================================================
# HELPER FUNCTIONS
# ==============================================================================

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_step() { echo -e "${CYAN}➜ $1${NC}"; }

show_help() {
  echo -e "${BOLD}Git Manager (gm) v${VERSION}${NC}"
  echo "========================================================"
  echo "Quản lý nhiều tài khoản Git trên cùng một máy."
  echo ""
  echo -e "${BOLD}COMMANDS:${NC}"
  echo -e "  ${GREEN}init${NC}     --git-server <domain> --username <name> [--email <addr>]"
  echo "           Thiết lập thư mục và SSH Key cho tài khoản mới."
  echo ""
  echo -e "  ${GREEN}clone${NC}    <git-url>"
  echo "           Clone repo vào đúng thư mục ~/Repos/Server/User."
  echo ""
  echo -e "  ${GREEN}status${NC}   [username]"
  echo "           Dashboard: Kiểm tra trạng thái thay đổi, chưa push."
  echo ""
  echo -e "  ${GREEN}sync${NC}     [username]"
  echo "           Fetch all, Prune remote, Pull current branch."
  echo ""
  echo -e "  ${GREEN}prune${NC}"
  echo "           Xóa các nhánh local mà remote đã xóa (dọn rác)."
  echo ""
  echo -e "  ${GREEN}list${NC}"
  echo "           Hiện cây thư mục Repos."
  echo ""
  echo -e "  ${GREEN}whoami${NC}"
  echo "           Kiểm tra danh tính Git trong thư mục hiện tại."
  echo ""
}

# Phân tích URL git để lấy Server, User, Repo name
parse_git_url() {
  local url=$1
  # Support SSH: git@github.com:user/repo.git
  if [[ "$url" =~ ^git@([^:]+):([^/]+)/(.+?)(\.git)?$ ]]; then
    echo "${BASH_REMATCH[1]} ${BASH_REMATCH[2]} ${BASH_REMATCH[3]}"
  # Support HTTPS: https://github.com/user/repo.git
  elif [[ "$url" =~ ^https://([^/]+)/([^/]+)/(.+?)(\.git)?$ ]]; then
    echo "${BASH_REMATCH[1]} ${BASH_REMATCH[2]} ${BASH_REMATCH[3]}"
  else
    return 1
  fi
}

# ==============================================================================
# CORE FUNCTIONS
# ==============================================================================

cmd_init() {
  local GIT_SERVER=""
  local USERNAME=""
  local USER_EMAIL=""

  shift
  while [[ "$#" -gt 0 ]]; do
    case $1 in
    --git-server)
      GIT_SERVER="$2"
      shift
      ;;
    --username)
      USERNAME="$2"
      shift
      ;;
    --email)
      USER_EMAIL="$2"
      shift
      ;;
    *) ;;
    esac
    shift
  done

  if [ -z "$GIT_SERVER" ] || [ -z "$USERNAME" ]; then
    log_error "Thiếu tham số. Vui lòng dùng: gm init --git-server <domain> --username <name>"
    exit 1
  fi

  local BASE_DIR="$REPOS_ROOT/$GIT_SERVER/$USERNAME"
  local SSH_KEY_NAME="id_ed25519_${GIT_SERVER}_${USERNAME}"
  local SSH_KEY_PATH="$HOME/.ssh/$SSH_KEY_NAME"
  local LOCAL_GITCONFIG="$BASE_DIR/.gitconfig_custom"

  log_step "Cấu hình cho: $USERNAME @ $GIT_SERVER"

  # 1. Tạo thư mục
  if [ ! -d "$BASE_DIR" ]; then
    mkdir -p "$BASE_DIR"
    log_success "Đã tạo thư mục: $BASE_DIR"
  fi

  # 2. Tạo SSH Key
  if [ ! -f "$SSH_KEY_PATH" ]; then
    ssh-keygen -t ed25519 -C "${USERNAME}@${GIT_SERVER}" -f "$SSH_KEY_PATH" -N "" -q
    log_success "Đã tạo SSH Key: $SSH_KEY_PATH"
    echo ""
    echo -e "${YELLOW}================================================================${NC}"
    echo -e "${BOLD}HÃY COPY PUBLIC KEY NÀY VÀO ${GIT_SERVER} -> SETTINGS -> SSH KEYS:${NC}"
    echo -e "${YELLOW}================================================================${NC}"
    cat "${SSH_KEY_PATH}.pub"
    echo -e "${YELLOW}================================================================${NC}"
    echo ""
  else
    log_info "SSH Key đã tồn tại, bỏ qua bước tạo key."
  fi

  # 3. Tạo Git Config Local
  echo "[user]" >"$LOCAL_GITCONFIG"
  echo "    name = $USERNAME" >>"$LOCAL_GITCONFIG"
  [ ! -z "$USER_EMAIL" ] && echo "    email = $USER_EMAIL" >>"$LOCAL_GITCONFIG"

  echo "[core]" >>"$LOCAL_GITCONFIG"
  echo "    sshCommand = \"ssh -i $SSH_KEY_PATH -o IdentitiesOnly=yes\"" >>"$LOCAL_GITCONFIG"
  log_info "Đã tạo file config riêng: $LOCAL_GITCONFIG"

  # 4. Map vào Global Config
  local GIT_DIR_PATTERN="gitdir:$BASE_DIR/"
  local EXISTING_CONF=$(git config --global --get-all includeIf."$GIT_DIR_PATTERN".path)

  if [ "$EXISTING_CONF" != "$LOCAL_GITCONFIG" ]; then
    git config --global includeIf."$GIT_DIR_PATTERN".path "$LOCAL_GITCONFIG"
    log_success "Đã cập nhật Global Git Config (includeIf)."
  fi

  echo -e "${GREEN}SUCCESS!${NC} Mọi repo trong '$BASE_DIR' sẽ tự động dùng user '$USERNAME'."
}

to_ssh_url() {
  local url="$1"
  if [[ "$url" =~ ^https://([^/]+)/([^/]+)/(.+)$ ]]; then
    echo "git@${BASH_REMATCH[1]}:${BASH_REMATCH[2]}/${BASH_REMATCH[3]}"
  else
    echo "$url"
  fi
}

cmd_clone() {
  local URL=$2
  if [ -z "$URL" ]; then
    log_error "Vui lòng nhập Git URL"
    exit 1
  fi

  read SERVER USER REPO <<<$(parse_git_url "$URL")

  if [ -z "$SERVER" ]; then
    log_error "Không phân tích được URL. Hãy dùng định dạng SSH hoặc HTTPS chuẩn."
    exit 1
  fi

  local TARGET_DIR="$REPOS_ROOT/$SERVER/$USER"

  if [ ! -d "$TARGET_DIR" ]; then
    log_error "Chưa tìm thấy cấu hình cho user '$USER' trên '$SERVER'."
    echo "Hãy chạy lệnh sau trước: gm init --git-server $SERVER --username $USER"
    exit 1
  fi

  URL=$(to_ssh_url "$URL")
  log_step "Clone từ $SERVER (User: $USER) ..."
  log_info "Destination: $TARGET_DIR/$REPO"

  mkdir -p "$TARGET_DIR"
  cd "$TARGET_DIR"
  git clone "$URL"
}

cmd_status() {
  local FILTER_USER=$2
  log_step "Đang quét trạng thái Repositories..."

  # Tìm kiếm sâu đến cấp 3 (Server/User/Repo) để check .git
  # Handle cả thư mục .git (repo thường) và file .git (worktree)
  find "$REPOS_ROOT" -mindepth 3 -maxdepth 4 -name ".git" | while read gitpath; do
    local workdir=""
    if [ -d "$gitpath" ]; then
      workdir=$(dirname "$gitpath") # Là repo thường
    else
      workdir=$(dirname "$gitpath") # Là worktree (file .git)
    fi

    # Filter user
    if [ ! -z "$FILTER_USER" ] && [[ "$workdir" != *"$FILTER_USER"* ]]; then continue; fi

    cd "$workdir" 2>/dev/null || continue

    local branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
    [ -z "$branch" ] && continue # Bỏ qua nếu lỗi

    local status_porcelain=$(git status --porcelain 2>/dev/null)
    local unpushed=$(git log @{u}.. 2>/dev/null)
    local display_path=${workdir#"$REPOS_ROOT/"}

    if [ ! -z "$status_porcelain" ]; then
      echo -e "${RED}[DIRTY]${NC} $display_path ${GRAY}($branch)${NC}"
    elif [ ! -z "$unpushed" ]; then
      echo -e "${BLUE}[AHEAD]${NC} $display_path ${GRAY}($branch)${NC} (Chưa push)"
      # else
      # echo -e "${GREEN}[OK]${NC}    $display_path"
    fi
  done
  echo "--- Quét hoàn tất ---"
}

cmd_sync() {
  local FILTER_USER=$2
  log_step "Bắt đầu đồng bộ (Fetch All + Pull)..."

  find "$REPOS_ROOT" -mindepth 3 -maxdepth 4 -name ".git" | while read gitpath; do
    local workdir=$(dirname "$gitpath")
    if [ ! -z "$FILTER_USER" ] && [[ "$workdir" != *"$FILTER_USER"* ]]; then continue; fi

    local display_path=${workdir#"$REPOS_ROOT/"}
    printf "Syncing %-50s " "$display_path"

    cd "$workdir" 2>/dev/null || continue

    # 1. Fetch tất cả info từ remote (bao gồm prune remote tracking branch)
    git fetch --all --prune -q >/dev/null 2>&1

    # 2. Pull nhánh hiện tại
    local pull_output=$(git pull 2>&1)
    local pull_exit_code=$?

    if [ $pull_exit_code -eq 0 ]; then
      echo -e "[${GREEN}OK${NC}]"
    else
      # Bỏ qua lỗi nếu không có upstream (nhánh mới tạo local)
      if [[ "$pull_output" == *"no tracking information"* ]]; then
        echo -e "[${YELLOW}SKIP${NC}] (No upstream)"
      else
        echo -e "[${RED}FAIL${NC}]"
        # echo "  Error: $pull_output"
      fi
    fi
  done
}

cmd_prune() {
  log_step "Dọn dẹp các nhánh Local đã bị xóa trên Remote..."

  find "$REPOS_ROOT" -mindepth 3 -maxdepth 4 -name ".git" | while read gitpath; do
    local workdir=$(dirname "$gitpath")
    cd "$workdir" 2>/dev/null || continue

    # Update info mới nhất
    git fetch -p -q

    # Tìm các nhánh có upstream là ': gone]'
    local gone_branches=$(git branch -vv | grep ': gone]' | awk '{print $1}')

    if [ ! -z "$gone_branches" ]; then
      local current_branch=$(git branch --show-current)
      local display_path=${workdir#"$REPOS_ROOT/"}
      echo -e "${YELLOW}Repo: $display_path${NC}"

      for branch in $gone_branches; do
        echo -n "  - Deleting '$branch' ... "
        [ "$branch" = "$current_branch" ] && {
          echo -e "${YELLOW}Skip${NC} (currently checked out)"
          continue
        }

        git branch -d "$branch" >/dev/null 2>&1
        if [ $? -eq 0 ]; then
          echo -e "${GREEN}Deleted${NC}"
        else
          echo -e "${RED}Failed${NC} (Force delete needed or checked out?)"
        fi
      done
    fi
  done
  log_success "Dọn dẹp hoàn tất."
}

cmd_list() {
  echo -e "${BOLD}Danh sách Repositories tại $REPOS_ROOT:${NC}"
  if command -v tree &>/dev/null; then
    tree -L 3 -d "$REPOS_ROOT"
  else
    find "$REPOS_ROOT" -maxdepth 3 -mindepth 3 -type d | sed -e "s|$REPOS_ROOT/||g" | sort
  fi
}

cmd_whoami() {
  local current_dir=$(pwd)

  echo -e "${BOLD}Current Context:${NC}"
  echo -e "  Path : $current_dir"

  local user_name=$(git config user.name)
  local user_email=$(git config user.email)
  local ssh_cmd=$(git config core.sshCommand)
  local remote_url=$(git remote get-url origin 2>/dev/null)

  echo -e "  User : ${GREEN}${user_name:-System Default}${NC}"
  echo -e "  Email: ${GREEN}${user_email:-System Default}${NC}"

  if [ ! -z "$ssh_cmd" ]; then
    echo -e "  Auth : ${CYAN}Custom SSH Identity (Managed by gm)${NC}"
    echo -e "         $ssh_cmd"
  else
    echo -e "  Auth : ${YELLOW}System Default Identity${NC}"
  fi

  if [ ! -z "$remote_url" ]; then
    echo -e "  Remote: $remote_url"
  fi
}

# ==============================================================================
# MAIN
# ==============================================================================

if [ $# -eq 0 ]; then
  show_help
  exit 1
fi

CMD=$1

case "$CMD" in
init) cmd_init "$@" ;;
clone) cmd_clone "$@" ;;
status) cmd_status "$@" ;;
sync) cmd_sync "$@" ;;
prune) cmd_prune "$@" ;;
list) cmd_list ;;
whoami) cmd_whoami ;;
*)
  show_help
  exit 1
  ;;
esac
