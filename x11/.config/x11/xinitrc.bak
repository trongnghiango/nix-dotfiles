#!/bin/sh

# ===============================================================
# 1. KHỞI TẠO MÔI TRƯỜNG CƠ BẢN
# ===============================================================

# Khởi chạy D-Bus Session (Chỉ chạy 1 lần)
# Đây là xương sống để các app giao tiếp với nhau
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
  eval $(dbus-launch --sh-syntax --exit-with-session)
fi

# Load cấu hình cá nhân (Theme, Font settings...)
if [ -f "${XDG_CONFIG_HOME:-$HOME/.config}/x11/xprofile" ]; then
  . "${XDG_CONFIG_HOME:-$HOME/.config}/x11/xprofile"
elif [ -f "$HOME/.xprofile" ]; then
  . "$HOME/.xprofile"
fi

# Cập nhật biến môi trường cho DBus/Systemd (Fix lỗi theme con trỏ, fcitx...)
dbus-update-activation-environment --systemd --all

# ===============================================================
# 2. ỨNG DỤNG CHẠY NỀN (BACKGROUND APPS)
# ===============================================================

# Trayer: Chỉ chạy nếu chưa có (Tránh trùng lặp)
if ! pgrep -x "trayer" >/dev/null; then
  trayer --edge top --align left --widthtype request --padding 0 \
    --SetDockType true --tint 0x222222 --height 24 \
    --transparent true --alpha 0 &
fi

# ===============================================================
# 3. QUẢN LÝ AUDIO (PIPEWIRE THỦ CÔNG)
# Fix lỗi mất tiếng khi Relogin & Fix icon volume lúc boot
# ===============================================================

USER_ID=$(id -u)

check_and_run() {
  if ! pgrep -x "$1" >/dev/null; then
    "$@" &
  fi
}

# --- A. DỌN DẸP TÀN DƯ (ZOMBIE KILLER) ---
# Nếu socket file không còn (do X crash) mà process vẫn sống -> Giết sạch
if [ ! -e "/run/user/$USER_ID/pipewire-0" ] && pgrep -x pipewire >/dev/null; then
  killall -9 pipewire pipewire-pulse wireplumber 2>/dev/null
  sleep 1
fi

# --- B. KHỞI ĐỘNG TUẦN TỰ ---
check_and_run pipewire
sleep 1 # Đợi Core lên
check_and_run wireplumber
check_and_run pipewire-pulse

# --- C. FIX ICON VOLUME (QUAN TRỌNG) ---
# Đợi thêm 3s cho Audio ổn định, rồi gửi tín hiệu bắt dwmblocks cập nhật ngay.
# Giả sử trong blocks.h volume dùng signal 10.
(sleep 3 && pkill -RTMIN+11 dwmblocks) &

# ===============================================================
# 4. KHỞI ĐỘNG DWM
# ===============================================================

# Dùng exec để thay thế process shell hiện tại bằng dwm (Tiết kiệm RAM)
# ssh-agent giữ key SSH để không phải nhập pass nhiều lần
exec ssh-agent dwm
