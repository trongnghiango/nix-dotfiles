#!/bin/sh

# --- 1. Xá»¬ LÃ CLICK ---
case $BLOCK_BUTTON in
1) setsid -f st -e btop ;; # Click trÃ¡i: Má»Ÿ btop
3)
  # Click pháº£i: Láº¥y nhiá»‡t Ä‘á»™ tá»« sensors, lÃ m Ä‘áº¹p vÃ  notify
  # Lá»c láº¥y: Fan Speed, CPU Temp, Core Temp, Pin (náº¿u cáº§n)
  INFO=$(sensors | awk '
            # Báº¯t dÃ²ng Fan
            /^fan1:/ { printf "ğŸŒªï¸ Fan: %s RPM\n", $2 }
            # Báº¯t dÃ²ng CPU (cá»§a thinkpad-isa)
            /^CPU:/ { printf "ğŸ”¥ CPU Package: %s\n", $2 }
            # Báº¯t cÃ¡c Core (cá»§a coretemp-isa)
            /^Core 0:/ { printf "1ï¸âƒ£ Core 0: %s\n", $3 }
            /^Core 1:/ { printf "2ï¸âƒ£ Core 1: %s\n", $3 }
        ')
  notify-send "ğŸŒ¡ï¸ Sensors Info (ThinkPad X230)" "$INFO"
  ;;
esac

# --- 2. TÃNH TOÃN CPU LOAD ---
# Logic nÃ y cá»§a báº¡n Ä‘Ã£ chuáº©n, giá»¯ nguyÃªn Ä‘á»ƒ nháº¹ mÃ¡y.
# Äá»c láº§n 1
read -r cpu a b c previdle rest </proc/stat
prevtotal=$((a + b + c + previdle))

# Äá»£i 0.2s (Ä‘á»§ nhanh mÃ  khÃ´ng lag bar)
sleep 0.2

# Äá»c láº§n 2
read -r cpu a b c idle rest </proc/stat
total=$((a + b + c + idle))

# TÃ­nh % (trÃ¡nh chia cho 0)
diff_total=$((total - prevtotal))
diff_idle=$((idle - previdle))

if [ "$diff_total" -eq 0 ]; then
  cpu_usage=0
else
  cpu_usage=$((100 * (diff_total - diff_idle) / diff_total))
fi

# --- 3. HIá»‚N THá»Š ICON MÃ€U MÃˆ ---
# ThÃªm logic Ä‘á»•i icon/mÃ u cáº£nh bÃ¡o náº¿u CPU cao > 80%
ICON="ï’¼"
COLOR="^C15^" # Máº·c Ä‘á»‹nh tráº¯ng

if [ "$cpu_usage" -ge 80 ]; then
  COLOR="^C9^" # Äá» (giáº£ Ä‘á»‹nh palette mÃ u sá»‘ 9 lÃ  Ä‘á»)
  ICON="ğŸ”¥"
fi

printf "^C4^$ICON $COLOR$cpu_usage%% "
