#!/usr/bin/env bash
set -u

systemctl is-active --quiet bluetooth || sudo systemctl start bluetooth

notify() {
    command -v notify-send >/dev/null && notify-send "Bluetooth" "$1"
}

confirm() {
    printf "%s [y/N]: " "$1"
    read -r ans
    [[ "$ans" =~ ^[Yy]$ ]]
}

# Lấy danh sách thiết bị đã pair
devices=$(bluetoothctl devices Paired)
[ -z "$devices" ] && notify "No paired devices to clean" && exit 0

choice=$(echo "$devices" | fzf --prompt="Clean > ")
[ -z "$choice" ] && exit 0

mac=$(awk '{print $2}' <<<"$choice")
name=$(awk '{$1=$2=""; print substr($0,3)}' <<<"$choice")

confirm "Remove device '$name' ?" || exit 0

# Clean đúng trình tự
bluetoothctl disconnect "$mac" >/dev/null 2>&1
bluetoothctl remove "$mac" >/dev/null 2>&1

notify "Device removed. Put it into pairing mode to pair again."
