#!/usr/bin/env python3

import sys
import time
import subprocess
from pydbus import SystemBus
from gi.repository import GLib

bus = SystemBus()
mngr = bus.get("org.bluez", "/")
loop = GLib.MainLoop()

devices = {}

def on_iface_added(path, interfaces):
    dev = interfaces.get("org.bluez.Device1")
    if not dev:
        return

    addr = dev.get("Address")
    name = dev.get("Name", "Unknown")
    if addr not in devices:
        devices[addr] = name
        print(f"{addr} {name}", flush=True)

mngr.onInterfacesAdded = on_iface_added

# Lấy adapter
objs = mngr.GetManagedObjects()
adapter_path = None
for p, ifaces in objs.items():
    if "org.bluez.Adapter1" in ifaces:
        adapter_path = p
        break

if not adapter_path:
    print("No Bluetooth adapter found")
    sys.exit(1)

adapter = bus.get("org.bluez", adapter_path)

# Bật adapter
adapter.Powered = True
adapter.Discoverable = True
adapter.Pairable = True

print(">>> Put device into PAIRING MODE (hold power 5–10s)", file=sys.stderr)

# Bắt đầu scan
adapter.StartDiscovery()

# Thu device trong 20s → fzf
try:
    proc = subprocess.Popen(
        ["fzf", "--prompt=Pair > "],
        stdin=subprocess.PIPE,
        text=True,
    )

    start = time.time()
    while time.time() - start < 20:
        while devices:
            addr, name = devices.popitem()
            proc.stdin.write(f"{addr} {name}\n")
            proc.stdin.flush()
        time.sleep(0.2)

    proc.stdin.close()
    proc.wait()
    selection = proc.stdout.read() if proc.stdout else None

except KeyboardInterrupt:
    adapter.StopDiscovery()
    sys.exit(0)

adapter.StopDiscovery()

if proc.returncode != 0:
    print("No device selected")
    sys.exit(1)

line = proc.stdout.read() if proc.stdout else None
if not line:
    print("No device selected")
    sys.exit(1)

mac = line.strip().split()[0]

dev_path = f"{adapter_path}/dev_{mac.replace(':', '_')}"
dev = bus.get("org.bluez", dev_path)

# Pair / trust / connect
dev.Pair()
dev.Trusted = True
dev.Connect()

print("✓ Paired & connected")
