#!/bin/sh

# ==============================================================================
# CONFIGURATION
# ==============================================================================
PROG="dwmblocks"
# Náº¡p Ä‘Æ°á»ng dáº«n script con (Quan trá»ng)
export PATH="$HOME/.local/bin:$PATH"
export DISPLAY=:0

# ==============================================================================
# FUNCTIONS
# ==============================================================================

# HÃ m dá»n dáº¹p: Giáº¿t sáº¡ch sáº½ má»i thá»© liÃªn quan
cleanup() {
  echo "ğŸ§¹ Cleaning up old processes..."
  # Giáº¿t dwmblocks
  killall -9 "$PROG" >/dev/null 2>&1

  # Giáº¿t luÃ´n táº¥t cáº£ cÃ¡c script con (ka-*) Ä‘ang cháº¡y ngáº§m
  # Lá»‡nh nÃ y tÃ¬m táº¥t cáº£ process cÃ³ tÃªn ka- vÃ  giáº¿t sáº¡ch
  pkill -9 -f "ka-" >/dev/null 2>&1

  # Giáº¿t cáº£ slstatus/conky náº¿u cÃ³
  killall -9 slstatus conky >/dev/null 2>&1

  sleep 0.5
}

# HÃ m cháº¡y chÆ°Æ¡ng trÃ¬nh
_launch() {
  # Cháº¡y tÃ¡ch biá»‡t khá»i terminal (setsid), áº©n output rÃ¡c (> /dev/null)
  # Náº¿u dwmblocks cá»§a báº¡n cáº§n pipe (in ra stdout), hÃ£y bá» comment dÃ²ng dÆ°á»›i vÃ  comment dÃ²ng setsid
  # "$PROG" | xargs -0 -I {} xsetroot -name "{}" &

  setsid "$PROG" >/dev/null 2>&1 &
}

launch() {
  # CÃ¡ch cÅ© (setsid) cÃ³ váº» Ä‘ang gÃ¢y lá»—i vá»›i báº£n build cá»§a báº¡n.
  # HÃ£y dÃ¹ng cÃ¡ch nÃ y: Chuyá»ƒn hÆ°á»›ng output vÃ o xsetroot.

  # 1. Cháº¡y dwmblocks
  # 2. DÃ¹ng xargs Ä‘á»ƒ báº¯t láº¥y chá»¯ in ra vÃ  nÃ©m lÃªn thanh bar
  # 3. Cháº¡y ná»n (&)

  "$PROG" | xargs -0 -I {} xsetroot -name "{}" &
}

# HÃ m hiá»ƒn thá»‹ tráº¡ng thÃ¡i Ä‘ang khá»Ÿi Ä‘á»™ng (Visual Feedback)
show_loading() {
  # YÃªu cáº§u cÃ i gÃ³i: xorg-xsetroot
  xsetroot -name "â™»ï¸  Restarting Statusbar..."
}

# ==============================================================================
# MAIN LOGIC
# ==============================================================================

case "$1" in
"reload" | "restart")
  echo "ğŸ”„ [RESTART MODE] Killing old processes..."
  cleanup

  echo "â³ Updating visual feedback..."
  show_loading
  sleep 0.5 # Giá»¯ chá»¯ Restarting má»™t chÃºt Ä‘á»ƒ máº¯t ká»‹p nhÃ¬n tháº¥y

  echo "ğŸš€ Launching new instance..."
  launch

  notify-send "DWMBlocks" "ÄÃ£ khá»Ÿi Ä‘á»™ng láº¡i thÃ nh cÃ´ng!"
  exit 0
  ;;

*)
  # Cháº¿ Ä‘á»™ Autostart (khi login)
  if pgrep -x "$PROG" >/dev/null; then
    echo "âœ… [AUTOSTART] $PROG is already running. Skipping."
    exit 0
  else
    echo "ğŸš€ [AUTOSTART] Starting $PROG..."
    # Dá»n dáº¹p sÆ¡ bá»™ Ä‘á» phÃ²ng process ma
    cleanup
    launch
  fi
  ;;
esac
