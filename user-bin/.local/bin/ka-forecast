#!/usr/bin/env bash

LOCATION="Govap"
CACHE_FILE="$HOME/.cache/weatherreport"
[ ! -f "$CACHE_FILE" ] && touch "$CACHE_FILE"

# HÃ m táº£i thá»i tiáº¿t (Cháº¡y tháº­t nhanh)
getforecast() {
  # Cháº¡y curl trong subshell ngáº§m, khÃ´ng lÃ m treo script chÃ­nh
  (
    data=$(timeout 10s curl -s "https://api.openweathermap.org/data/2.5/weather?lat=10.847&lon=106.670&units=metric&appid=c817622e5f134df0ef6bb60d0b4864c0")
    if echo "$data" | jq -e . >/dev/null 2>&1; then
      echo "$data" >"$CACHE_FILE"
      # Táº£i xong thÃ¬ gá»­i tÃ­n hiá»‡u refresh cho dwmblocks (Signal 14)
      pkill -RTMIN+14 dwmblocks
    fi
  ) &
}

# Logic Update:
# Náº¿u cache cÅ© quÃ¡ 30 phÃºt -> Gá»i hÃ m táº£i ngáº§m -> Script chÃ­nh cháº¡y tiáº¿p luÃ´n, khÃ´ng chá».
if [ ! -s "$CACHE_FILE" ] || [ $(($(date +%s) - $(date -r "$CACHE_FILE" +%s))) -gt 1800 ]; then
  getforecast
fi

# Xá»­ lÃ½ click chuá»™t
case $BLOCK_BUTTON in
1) getforecast && notify-send "Weather" "Updating in background..." ;;
3) notify-send "Weather Module" "Middle click to force update." ;;
esac

# =========================================================
# PHáº¦N HIá»‚N THá»Š (LuÃ´n tráº£ vá» ngay láº­p tá»©c)
# =========================================================

weather_data=$(cat "$CACHE_FILE")

# Náº¿u chÆ°a cÃ³ dá»¯ liá»‡u (láº§n Ä‘áº§u khá»Ÿi Ä‘á»™ng) -> Hiá»‡n icon Loading rá»“i thoÃ¡t ngay
if [ -z "$weather_data" ]; then
  echo "ğŸŒ¦ï¸ ..."
  exit 0
fi

# Parse JSON (Náº¿u cÃ³ dá»¯ liá»‡u)
desc=$(echo "$weather_data" | jq -r '.weather[0].description // empty' 2>/dev/null | sed -e "s/\b\(.\)/\u\1/g")
temp=$(echo "$weather_data" | jq -r '.main.temp // 0' 2>/dev/null | cut -d. -f1)
icon=$(echo "$weather_data" | jq -r '.weather[0].icon // "01d"' 2>/dev/null | tr -d 'nd')

# Map Icon nhanh
case $icon in
01) ico="ï”¢" ;; 02) ico="â›…" ;; 03) ico="ğŸŒ«ï¸" ;; 04) ico="â˜ï¸" ;;
09) ico="ğŸŒ§ï¸" ;; 10) ico="ğŸŒ¦ï¸" ;; 11) ico="ğŸŒ©ï¸" ;; 13) ico="â„ï¸" ;;
50) ico="ğŸ’¨" ;; *) ico="ğŸƒ" ;;
esac

# Map Temp
t_val=$((temp))
if [ "$t_val" -le 20 ]; then
  t_ico="ğŸ¥¶"
elif [ "$t_val" -ge 38 ]; then
  t_ico="ğŸ¥µ"
else t_ico="ğŸŒ"; fi

echo "[$ico $desc] [$t_ico $t_valÂ°C]"
