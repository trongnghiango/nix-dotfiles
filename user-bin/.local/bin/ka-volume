#!/usr/bin/env sh

# Kiá»ƒm tra xem wpctl cÃ³ tá»“n táº¡i khÃ´ng Ä‘á»ƒ trÃ¡nh lá»—i treo script
if ! command -v wpctl >/dev/null 2>&1; then
    echo "No wpctl"
    exit 1
fi

# --- 1. Xá»¬ LÃ CLICK/SCROLL ---
case $BLOCK_BUTTON in
1) setsid -f "$TERMINAL" -e pulsemixer ;; # Chuá»™t trÃ¡i: Má»Ÿ Mixer
2)
  # Chuá»™t giá»¯a: Toggle Mute & Update ngay láº­p tá»©c
  wpctl set-mute @DEFAULT_SINK@ toggle
  pkill -RTMIN+11 "${STATUSBAR:-dwmblocks}"
  ;;
4)
  # LÄƒn lÃªn: TÄƒng 5% (1% quÃ¡ cháº­m) & Update ngay
  wpctl set-volume -l 1.5 @DEFAULT_SINK@ 2%+
  pkill -RTMIN+11 "${STATUSBAR:-dwmblocks}"
  ;;
5)
  # LÄƒn xuá»‘ng: Giáº£m 5% & Update ngay
  wpctl set-volume @DEFAULT_SINK@ 2%-
  pkill -RTMIN+11 "${STATUSBAR:-dwmblocks}"
  ;;
3) notify-send "ğŸ“¢ Volume module" "ğŸ–± Middle: Mute\nğŸ–± Scroll: Change Volume" ;;
esac

# --- 2. Láº¤Y Dá»® LIá»†U ---
# Láº¥y cáº£ dÃ²ng info má»™t láº§n cho nhanh
WP_OUTPUT=$(wpctl get-volume @DEFAULT_AUDIO_SINK@)

# --- 3. Xá»¬ LÃ HIá»‚N THá»Š ---
if [ -z "$WP_OUTPUT" ]; then
  # TrÆ°á»ng há»£p khá»Ÿi Ä‘á»™ng chÆ°a xong -> Hiá»ƒn thá»‹ táº¡m dáº¥u 3 cháº¥m thay vÃ¬ icon lá»—i
  echo "^C4^ï€§ ^C15^..."
  exit
fi

# Kiá»ƒm tra Mute: Náº¿u chuá»—i chá»©a [MUTED]
if echo "$WP_OUTPUT" | grep -q "MUTED"; then
  echo "^C3^ï‘¦ ^C15^Muted"
  exit
fi

# Lá»c láº¥y sá»‘ Volume (Cáº¯t chuá»—i "Volume: 0.75" -> 0.75)
# DÃ¹ng awk xá»­ lÃ½ an toÃ n hÆ¡n split/IFS
VOL_FLOAT=$(echo "$WP_OUTPUT" | awk '{print $2}')

# Chuyá»ƒn Ä‘á»•i 0.75 -> 75 (DÃ¹ng awk Ä‘á»ƒ tÃ­nh toÃ¡n sá»‘ há»c chuáº©n xÃ¡c)
VOL_INT=$(awk -v v="$VOL_FLOAT" 'BEGIN { printf "%.0f", v * 100 }')

# Chá»n Icon theo má»©c Ä‘á»™
if [ "$VOL_INT" -ge 70 ]; then
  ICON="ğŸ”Š"
elif [ "$VOL_INT" -ge 30 ]; then
  ICON="ğŸ”‰"
else
  ICON="ğŸ”ˆ"
fi

# In ra káº¿t quáº£ (ThÃªm mÃ u sáº¯c cho Ä‘áº¹p náº¿u muá»‘n)
# ^C4^ lÃ  mÃ u xanh dÆ°Æ¡ng (tÃ¹y palette), ^C15^ tráº¯ng
echo "^C4^$ICON^C15^$VOL_INT%"
