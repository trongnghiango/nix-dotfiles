#!/bin/bash
# append_zshrc - ThÃªm ná»™i dung vÃ o .zshrc trong dotfiles structure

set -e

echo "ðŸ“ append_zshrc - ThÃªm ná»™i dung vÃ o Zsh config"

# XÃ¡c Ä‘á»‹nh Ä‘Æ°á»ng dáº«n chÃ­nh xÃ¡c dá»±a trÃªn cáº¥u trÃºc cá»§a báº¡n
DOTFILES_ROOT="$HOME/.dotfiles"
ZSHRC_PATHS=(
    "$DOTFILES_ROOT/zsh/.config/zsh/.zshrc"   # Vá»‹ trÃ­ trong dotfiles
    "$HOME/.config/zsh/.zshrc"                # Vá»‹ trÃ­ sau khi stow
    "$HOME/.zshrc"                            # Vá»‹ trÃ­ legacy
)

# TÃ¬m file .zshrc tá»“n táº¡i
ZSHRC_PATH=""
for path in "${ZSHRC_PATHS[@]}"; do
    if [ -f "$path" ]; then
        ZSHRC_PATH="$path"
        echo "ðŸ“ TÃ¬m tháº¥y: $ZSHRC_PATH"
        break
    fi
done

# Náº¿u khÃ´ng tÃ¬m tháº¥y, táº¡o trong dotfiles
if [ -z "$ZSHRC_PATH" ]; then
    ZSHRC_PATH="$DOTFILES_ROOT/zsh/.config/zsh/.zshrc"
    echo "ðŸ“„ Táº¡o file má»›i trong dotfiles: $ZSHRC_PATH"
    mkdir -p "$(dirname "$ZSHRC_PATH")"
    touch "$ZSHRC_PATH"
fi

# XÃ¡c Ä‘á»‹nh xem file Ä‘ang á»Ÿ Ä‘Ã¢u (dotfiles hay system)
if [[ "$ZSHRC_PATH" == "$DOTFILES_ROOT"* ]]; then
    echo "ðŸ’¾ LÆ°u trá»±c tiáº¿p vÃ o dotfiles"
    TARGET_TYPE="dotfiles"
else
    echo "âš¡ File Ä‘ang á»Ÿ system, kiá»ƒm tra xem cÃ³ pháº£i symlink khÃ´ng..."
    if [ -L "$ZSHRC_PATH" ]; then
        LINK_TARGET=$(readlink -f "$ZSHRC_PATH")
        echo "ðŸ”— ÄÃ¢y lÃ  symlink Ä‘áº¿n: $LINK_TARGET"
        if [[ "$LINK_TARGET" == "$DOTFILES_ROOT"* ]]; then
            echo "âœ… Symlink trá» Ä‘áº¿n dotfiles, tiáº¿p tá»¥c..."
            ZSHRC_PATH="$LINK_TARGET"
            TARGET_TYPE="dotfiles"
        else
            TARGET_TYPE="system"
        fi
    else
        TARGET_TYPE="system"
    fi
fi

echo -e "\nâœï¸  Nháº­p ná»™i dung muá»‘n thÃªm vÃ o $ZSHRC_PATH"
echo "   (Nháº¥n Ctrl+D Ä‘á»ƒ káº¿t thÃºc, Ctrl+C Ä‘á»ƒ há»§y):"
echo "   -----------------------------------------"

# Äá»c ná»™i dung multi-line
CONTENT=$(cat)

if [ -z "$CONTENT" ]; then
    echo "âš ï¸  KhÃ´ng cÃ³ ná»™i dung. ThoÃ¡t."
    exit 0
fi

# Hiá»ƒn thá»‹ preview
echo -e "\nðŸ“‹ Preview:"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "$CONTENT"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# XÃ¡c nháº­n
read -p "âœ… ThÃªm ná»™i dung trÃªn? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "ðŸš« ÄÃ£ há»§y."
    exit 0
fi

# Backup náº¿u file Ä‘Ã£ tá»“n táº¡i vÃ  cÃ³ ná»™i dung
if [ -s "$ZSHRC_PATH" ]; then
    BACKUP="${ZSHRC_PATH}.backup.$(date +%Y%m%d_%H%M%S)"
    cp "$ZSHRC_PATH" "$BACKUP"
    echo "ðŸ’¾ Backup: $BACKUP"
fi

# ThÃªm ná»™i dung
{
    echo ""
    echo "# --- ThÃªm bá»Ÿi append_zshrc [$(date '+%Y-%m-%d %H:%M:%S')] ---"
    echo "$CONTENT"
    echo "# --- Káº¿t thÃºc ---"
    echo ""
} >> "$ZSHRC_PATH"

echo "ðŸŽ‰ ÄÃ£ thÃªm thÃ nh cÃ´ng!"
echo ""
echo "ðŸ“Œ Vá»‹ trÃ­: $ZSHRC_PATH"
echo "ðŸ“Œ Loáº¡i: $TARGET_TYPE"

if [ "$TARGET_TYPE" = "dotfiles" ]; then
    echo "ðŸ”„ Ãp dá»¥ng: cd ~/.dotfiles && stow -t ~ -R zsh"
fi

echo "âš¡ Ãp dá»¥ng ngay: source '$HOME/.config/zsh/.zshrc' 2>/dev/null || source '$HOME/.zshrc'"
